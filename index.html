<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=400, initial-scale=0.9">
    <meta name="description" content="Discover the ultimate dining experience at the University of Patras with Estia Patrwn (Εστία Πατρών) - your comprehensive guide to the campus dining hall known as Estia Patra, λέσχη, or εστιατόριο πανεπιστημίου Πατρών. Our page offers detailed insights into daily menus, πρόγραμμα, along with live updates on line size, waiting times (αναμονή εστίας), queue size (ουρά εστίας), and seating capacity, ensuring you make the most of your dining experience. Whether you're planning your next meal or curious about today's special, we provide all the essential information to enhance your dining at Estia Patra. Stay ahead of the crowd with our timely updates and embrace the vibrant culinary culture at the University of Patras.">
    <meta name="theme-color" content="#fd8353">
    <title>University Restaurant Dashboard Patras</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">


    
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo-container">
                <div class="logo">Sense Campus Patras</div>
            </div>
            

        </div>
    </header>
    
    
    <main class="main-content container">
        <div class="main-content"></div>
            <section id="wait-times" class="chart-section">
                <div class="chart-title"></div>
                <h2 style="display: inline-block; vertical-align: middle; padding-left: 15px;">Waiting Area</h2>
                <h2 id="current_WaitTime" class="count" style="display: inline-block; vertical-align: middle; padding-right: 10px; width: 2em; text-align: right;">NaN</h2>
                
                <img class="svg" src="media/users.svg" alt="Crowd Icon" style="display: inline-block; width: 45px; height: 45px; vertical-align: middle; padding-bottom: 8px; padding-right: 5px;">
                    
                </div>
                <div class="chart-container">
                    <canvas id="waitTimeChart"></canvas>
                </div>
            </section>
        
        
            <section id="line-sizes" class="chart-section">
                <div class="chart-title"></div>
                    <h2 style="display: inline-block; vertical-align: middle; padding-left: 15px;">Restaurant</h2>
                    <h2 id="current_LineSize" class="count" style="display: inline-block; vertical-align: middle; padding-right: 15px; width: 2em; text-align: right;">NaN</h2>
                    
                    <img class="svg" src="media/seat.svg" alt="Chair Icon" style="display: inline-block; width: 45px; height: 45px; vertical-align: middle; padding-right: 0px;padding-left: 5px;">
                </div>
                <div class="chart-container">
                    <canvas id="lineSizeChart"></canvas>
                </div>
            </section>

            <section id="restaurant-capacity" class="capacity-section">
                <div class="capacity-title">
                    <h2 style="display: inline-block; vertical-align: middle; padding-left: 5px;">Traffic</h2>
                    <h2 id="current_Capacity" class="count" style="display: inline-block; vertical-align: middle; padding-left: 5px; width: 2em; text-align: right;">NaN</h2> 
                    <img class="svg" src="media/clock.svg" alt="Clock Icon" style="display: inline-block; width: 30px; height: 30px; vertical-align: bottom; padding-bottom: 0px;padding-right: 2px;padding-top: 5px;">
                </div>
                <div class="capacity-container">
                    <div id="capacity-bar" class="capacity-bar"></div>
                </div>
                <div class="capacity-axis">
                    <span>0%</span>
                    <span>25%</span>
                    <span>50%</span>
                    <span>75%</span>
                    <span>100%</span>
                </div>
            </section>
            

            <section id="todays-menu" class="menu-section">
                <h2 class="Menu-Title">&nbsp;Today's Menu</h2>
                <button class="more-btn" id="moreButton">More</button>
                <div class="menu-container">
                    <div id="breakfast-menu" class="menu-item">
                        <h3>Breakfast</h3>
                    </div>
                    <div id="lunch-menu" class="menu-item">
                        <h3>Lunch</h3>
                    </div>
                    <div id="dinner-menu" class="menu-item">
                        <h3>Dinner</h3>
                    </div>
                </div>

            </section>
            
            
        </div>
        

    </main>
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; position: sticky; top: 0; left: 0; z-index: 10; width: 100%;">
                <span class="close" style="text-align: left;">&times;</span>
                <a id="pdf-download-link" href="" download style="text-align: right;padding-top: 0px;" class="no-link-style">Download PDF</a>
            </div>
            <div>
                <br>
            </div>
            <canvas id="pdf-canvas" style="padding-left: 350px;"></canvas>
            <div id="pdf-info">
                <br>
                <button id="prev-page" class="no-link-style" style="background:none;border:none;color:#6d6564 ;cursor:pointer;padding-top: 3px;">Previous Week</button>
                <button id="week-number" class="no-link-style" style="background:none;border:none;color:#6d6564;cursor:pointer; margin-left: 15px; padding-top: 3px;">Next Week</button>
                <br>
                <button id="breakfast-page" class="no-link-style" style="background:none;border:none;color:#6d6564;cursor:pointer; ">Breakfast Schedule</button>
                <span class="close_bottom" style="text-align: right;">&times;</span>
                
                
            </div>
            
        </div>
    </div>

    <footer class="footer">
 
        <div class="container">
            <p class="contact-info">&copy; SenseCampusPatras. All rights reserved.</p>
            <p class="contact-info" id="contact-info">Contact us: sensecampus@gmail.com</p>
            <div id="last-updated" class="last-updated"></div>
        </div>
    </footer>


    <nav class="bottom-nav">
        <div class="navbar">
            <a href="#home" class="active">Queue</a>
            <a href="#todays-menu">Menu</a>
            <a class="more-butn" role="button" tabindex="0">
                <img src="media/refresh.svg" alt="Refresh Icon" style="width:30px; height:30px;">
                <span id="timer" style="width:35px;">01:00</span>
            </a>
        </div>
    </nav>

    <script>
document.addEventListener("DOMContentLoaded", function () {
    let pdfDoc = null,
        currentPage = 1, // Track the current page
        canvas = document.getElementById('pdf-canvas'),
        ctx = canvas.getContext('2d'),
        pdfContainer = document.querySelector('.modal-content'),
        totalPages = 0;  // Track the total number of pages

    const modal = document.getElementById('pdfModal');
    const closeModal = document.getElementsByClassName('close')[0];
    const closeModalBottom = document.getElementsByClassName('close_bottom')[0];
    const moreButton = document.getElementById('moreButton');
    const downloadLink = document.getElementById('pdf-download-link');
    const nextPageButton = document.getElementById('week-number'); // Use the button instead of the text span
    const prevPageButton = document.getElementById('prev-page'); // Previous Page button
    const breakfastPageButton = document.getElementById('breakfast-page'); // Previous Page button
    let breakfast_mode=0;
    let today_const;

    const pdfUrl = 'programma.pdf';
    downloadLink.href = pdfUrl;

    modal.style.display = "none";
    document.body.classList.remove('modal-open');

    const loadPDF = async (url) => {
        const loadingTask = pdfjsLib.getDocument(url);
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        //document.getElementById('total-pages').textContent = totalPages;

        currentPage = getWeekOfMonth(); // Initialize with the current week number
        today_const=getWeekOfMonth();
        await renderPage(currentPage);

        scrollToCurrentDay(); // Optional: Scroll to the correct part of the canvas
    };

    const renderPage = async (pageNum) => {
        if (pageNum <= 0 || pageNum > totalPages) return; // Ensure valid page numbers

        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: 1 });

        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const renderContext = {
            canvasContext: ctx,
            viewport: viewport
        };

        await page.render(renderContext).promise;
    };

    const scrollToCurrentDay = () => {
        let today = new Date().getDay();
        if (today === 0) today = 7;

        const daysInWeek = 7;
        const canvasWidth = canvas.width;
        const dayWidth = canvasWidth / daysInWeek;
        const scrollX = dayWidth * (today - 1);

        pdfContainer.scrollTo({
            left: scrollX - 120,
            behavior: 'smooth'
        });
    };

    const scrollToStart = () => {

        const scrollX = 25

        pdfContainer.scrollTo({
            left: scrollX,
            behavior: 'smooth'
        });
    };

    // Change to the next page when the "Next Page" button is clicked
    nextPageButton.onclick = async function () {
        breakfastPageButton.textContent = "Breakfast Schedule";
        currentPage += 1;
        if (currentPage > totalPages-1) { //-1 for the breakfast tab
            currentPage = currentPage-1; 
        }
        await renderPage(currentPage); // Render the new page
        if (currentPage==today_const){
            scrollToCurrentDay();
        }
        else {
            scrollToStart();
        }
    };

    // Change to the previous page when the "Previous Page" button is clicked
    prevPageButton.onclick = async function () {
        breakfastPageButton.textContent = "Breakfast Schedule";
        currentPage -= 1;
        if (currentPage < 1) {
            currentPage = currentPage+1; 
        }
        await renderPage(currentPage); // Render the previous page
        if (currentPage==today_const){
            scrollToCurrentDay();
        }
        else {
            scrollToStart();
        }
    };

    // Change to the previous page when the "Previous Page" button is clicked
    breakfastPageButton.onclick = async function () {
        breakfast_mode=(breakfast_mode+1)%2;
        if (breakfast_mode==1){
        await renderPage(totalPages); // Render the breakafast tab

        //console.log(breakfast_mode)
        breakfastPageButton.textContent = "Week Schedule";
        }
        else{
            //console.log(breakfast_mode)
            await renderPage(currentPage);
            if (currentPage==today_const){
            scrollToCurrentDay();
        }        else {
            scrollToStart();
        }
            breakfastPageButton.textContent = "Breakfast Schedule";
        }
    };

    moreButton.onclick = function () {
        breakfast_mode=0;
        breakfastPageButton.textContent = "Breakfast Schedule";
        modal.style.display = "block";
        document.body.classList.add('modal-open');
        loadPDF(pdfUrl);
    };

    closeModal.onclick = function () {
        modal.style.display = "none";
        document.body.classList.remove('modal-open');
        // Force reflow by toggling display
        const mainContent = document.querySelector('.main-content');
        mainContent.style.display = 'none';
        mainContent.offsetHeight; // Trigger a reflow
        mainContent.style.display = ''; // Restore the display property
        // Programmatically click the "Menu" button after the reflow
        const menuButton = document.querySelector('a[href="#todays-menu"]');
        if (menuButton) {
            menuButton.click();  // Simulate a click on the "Menu" button
        }
    };
    closeModalBottom.onclick = function () {
        modal.style.display = "none";
        document.body.classList.remove('modal-open');
        // Force reflow by toggling display
        const mainContent = document.querySelector('.main-content');
        mainContent.style.display = 'none';
        mainContent.offsetHeight; // Trigger a reflow
        mainContent.style.display = ''; // Restore the display property
        // Programmatically click the "Menu" button after the reflow
        const menuButton = document.querySelector('a[href="#todays-menu"]');
        if (menuButton) {
            menuButton.click();  // Simulate a click on the "Menu" button
        }
    };

    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
            document.body.classList.remove('modal-open');
        }
        // Force reflow by toggling display
        const mainContent = document.querySelector('.main-content');
        mainContent.style.display = 'none';
        mainContent.offsetHeight; // Trigger a reflow
        mainContent.style.display = ''; // Restore the display property
        // Programmatically click the "Menu" button after the reflow
        const menuButton = document.querySelector('a[href="#todays-menu"]');
        if (menuButton) {
            menuButton.click();  // Simulate a click on the "Menu" button
        }
    };

    const getWeekOfMonth = () => {
        const now = new Date();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const firstDayOfWeek = firstDayOfMonth.getDay();
        const currentDay = now.getDate();
        const firstMonday = firstDayOfWeek === 1 ? 1 : (8 - (firstDayOfWeek === 0 ? 7 : firstDayOfWeek));
        if (currentDay <= firstMonday) return 1;
        const daysSinceFirstMonday = currentDay - firstMonday;
        return Math.floor(daysSinceFirstMonday / 7) + 2;
    };
});

    </script>

    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.5.141/pdf.min.js"></script>
    <script type="module" defer src="script.js"></script>
    


</body>
</html>
